<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠ</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    /* ---------- Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³Ù‡ÙˆÙ„Ø©) ---------- */
    :root{
      --forest-1: #428177; /* Forest */
      --forest-2: #054239;
      --forest-3: #002623;

      --wheat-1: #edebe0; /* Golden Wheat */
      --wheat-2: #b9a779;
      --wheat-3: #988561;

      --umber-1: #6b1f2a; /* Deep Umber */
      --umber-2: #4a151e;
      --umber-3: #260f14;

      --char-1: #ffffff; /* Charcoal - here used as white */
      --char-2: #3d3a3b;
      --char-3: #161616;

      --bg: var(--wheat-1);
      --card: #ffffff;
      --accent: var(--forest-1);
      --accent-dark: var(--forest-2);
      --cta: var(--umber-1);
    }

    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap');
    *{box-sizing:border-box}
    body{ font-family:'Tajawal',sans-serif; margin:0; background:var(--bg); color:var(--char-3); }

    header{ background:linear-gradient(90deg,var(--forest-2),var(--forest-1)); color:var(--char-1); padding:14px 16px; display:flex; align-items:center; justify-content:space-between }
    header h1{ margin:0; font-size:20px }
    header .actions{ display:flex; gap:8px; align-items:center }
    .btn{ background:var(--accent); color:var(--char-1); padding:8px 10px; border-radius:8px; text-decoration:none; display:inline-block; border:none; cursor:pointer }
    .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.25); }

    .wrap{ max-width:1100px; margin:16px auto; padding:12px; display:grid; grid-template-columns: 1fr 380px; gap:16px }

    /* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    #map{ width:100%; height:520px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); overflow:hidden }

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
    aside{ }
    .card{ background:var(--card); border-radius:12px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); margin-bottom:12px }
    .search{ display:flex; gap:8px; margin-bottom:10px }
    .search input, .search select{ padding:10px; border-radius:8px; border:1px solid #e6e6e6; width:100% }

    #list{ display:flex; flex-direction:column; gap:10px; max-height:340px; overflow:auto; padding-right:6px }
    .provider{ display:flex; gap:10px; align-items:center; padding:10px; border-radius:10px; border:1px solid #f0f0f0 }
    .provider img{ width:72px; height:72px; object-fit:cover; border-radius:8px; background:#f6f6f6 }
    .provider h3{ margin:0; font-size:16px }
    .small{ color:#666; font-size:13px }

    .card .muted{ color:#777; font-size:13px }

    /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© */
    form label{ display:block; margin-top:8px; font-size:13px }
    form input, form textarea, form select{ width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #e6e6e6 }
    textarea{ min-height:80px }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    .actions-row{ display:flex; gap:8px; margin-top:8px }
    .btn-whatsapp{ background:linear-gradient(90deg,#25D366,#128C7E); color:white }
    .btn-call{ background:linear-gradient(90deg,#00AEEF,#0077B6); color:white }

    /* ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ */
    .auth-row{ display:flex; gap:8px; align-items:center }

    footer{ text-align:center; color:#666; padding:14px }

    @media(max-width:980px){ .wrap{ grid-template-columns:1fr; } #map{ height:420px } aside{ order:2 } }
  </style>
</head>
<body>
<header>
  <h1>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h1>
  <div class="actions">
    <div class="small" id="userInfo">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
    <button class="btn" id="openLoginBtn">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
  </div>
</header>

<main class="wrap">
  <section>
    <div id="map" aria-label="Ø®Ø±ÙŠØ·Ø©"></div>

    <div class="card" style="margin-top:12px">
      <h3>ØªØ¹Ù„ÙŠÙ…Ø§Øª</h3>
      <p class="muted">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø£ÙŠ Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.</p>
    </div>
  </section>

  <aside>
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</h3>
        <button id="refreshBtn" class="btn ghost">ØªØ­Ø¯ÙŠØ«</button>
      </div>

      <div class="search" style="margin-top:10px">
        <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø®Ø¯Ù…Ø© Ø£Ùˆ Ø§Ø³Ù…" />
      </div>
      <div style="display:flex; gap:8px; margin-bottom:8px">
        <select id="filter" style="flex:1">
          <option value="all">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
        </select>
        <select id="cityFilter" style="width:140px">
          <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option>
        </select>
      </div>
      <div id="list" aria-live="polite"></div>
    </div>

    <div class="card" id="authCard">
      <h3 id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div id="authForms">
        <!-- Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="loginForm">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            <input id="login_user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
          </label>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            <input id="login_pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
          </label>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
            <button class="btn ghost" id="showSignupBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          </div>
        </div>

        <div id="signupForm" style="display:none">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            <input id="signup_user" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…" />
          </label>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            <input id="signup_pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" />
          </label>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button class="btn" id="signupBtn">Ø¥Ù†Ø´Ø§Ø¡</button>
            <button class="btn ghost" id="showLoginBtn">Ø¹ÙˆØ¯Ø©</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="addCard" style="display:none">
      <h3>Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <form id="addForm">
        <label>Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·
          <input id="f_name" required />
        </label>
        <label>Ø§Ù„ØªØµÙ†ÙŠÙ
          <select id="f_category">
            <option value="ØµÙŠØ¯Ù„ÙŠØ©">ØµÙŠØ¯Ù„ÙŠØ©</option>
            <option value="Ù…Ø³ØªØ´ÙÙ‰">Ù…Ø³ØªØ´ÙÙ‰</option>
            <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ">ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</option>
            <option value="Ø³Ø¨Ø§Ùƒ">Ø³Ø¨Ø§Ùƒ</option>
            <option value="Ù…ØºØ³Ù„Ø© Ø³ÙŠØ§Ø±Ø§Øª">Ù…ØºØ³Ù„Ø© Ø³ÙŠØ§Ø±Ø§Øª</option>
            <option value="Ù…Ù„Ø§Ø¹Ø¨">Ù…Ù„Ø§Ø¹Ø¨</option>
            <option value="Ø®Ø¯Ù…Ø§Øª Ø§Ø®Ø±Ù‰">Ø®Ø¯Ù…Ø§Øª Ø§Ø®Ø±Ù‰</option>
          </select>
        </label>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©)
          <input id="f_phone" placeholder="+964770xxxxxxx" />
        </label>
        <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø­ÙŠ
          <input id="f_city" placeholder="Ù…Ø«Ø§Ù„: Ø¨ØºØ¯Ø§Ø¯ - Ø§Ù„ÙƒØ±Ø®" />
        </label>
        <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          <input id="f_img" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº" />
        </label>
        <label>ÙˆØµÙ Ù‚ØµÙŠØ±
          <textarea id="f_desc"></textarea>
        </label>
        <div class="small">* Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø«Ù… Ø§Ø¶ØºØ· "Ø£Ø¶Ù Ø§Ù„Ø®Ø¯Ù…Ø©".</div>
        <div style="margin-top:10px; display:flex; gap:8px">
          <button class="btn" type="submit">Ø£Ø¶Ù Ø§Ù„Ø®Ø¯Ù…Ø©</button>
          <button type="button" id="logoutBtn" class="btn ghost">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
      <div class="small">ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø²ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙƒÙ…Ù„Ù JSON Ø£Ùˆ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ù…Ù† Ù…Ù„Ù JSON.</div>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button id="exportBtn" class="btn ghost">ØªÙ†Ø²ÙŠÙ„ JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" class="btn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
      </div>
    </div>

  </aside>
</main>

<footer>ØªÙ… ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù„Ù„Ø¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±. ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹Ù‡ Ø¹Ù„Ù‰ GitHub Pages Ù„ØªØ´ØºÙŠÙ„Ù‡ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø·.</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
// ---------- Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¨Ø¯Ø£ÙŠØ© (ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹) ----------
const SAMPLE = [
  { id:1, name:'ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø´ÙØ§Ø¡', category:'ØµÙŠØ¯Ù„ÙŠØ©', phone:'+9647701111111', city:'Ø§Ù„ÙƒØ±Ø®', lat:36.349, lng:44.005, img:'https://via.placeholder.com/200x140?text=ØµÙŠØ¯Ù„ÙŠØ©', desc:'ØµÙŠØ¯Ù„ÙŠØ© Ù…Ù†Ø§ÙˆØ¨Ø© 24 Ø³Ø§Ø¹Ø©' },
  { id:2, name:'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ Ø§Ù„Ø­Ù„ÙˆÙ„', category:'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ', phone:'+9647702222222', city:'Ø§Ù„Ø§Ø­Ù…Ø¯ÙŠ', lat:36.347, lng:44.01, img:'https://via.placeholder.com/200x140?text=ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ', desc:'ØµÙŠØ§Ù†Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù…Ù†Ø§Ø²Ù„' }
];

// ---------- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ----------
const map = L.map('map').setView([36.349, 44.006], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' }).addTo(map);
let providers = loadProviders();
let markers = {};
let tempMarker = null; // marker Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©

function loadProviders(){
  try{
    const raw = localStorage.getItem('providers_v2');
    if(raw) return JSON.parse(raw);
  }catch(e){ console.error(e) }
  // Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹ÙŠÙ†Ø§Øª
  return SAMPLE.slice();
}
function saveProviders(){ localStorage.setItem('providers_v2', JSON.stringify(providers)); }

function createMarker(p){
  const icon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize:[25,41], iconAnchor:[12,41] });
  const m = L.marker([p.lat,p.lng], { icon }).addTo(map);
  m.bindPopup(`<b>${escapeHtml(p.name)}</b><br>${escapeHtml(p.category)} â€¢ ${escapeHtml(p.city || '')}<br>${escapeHtml(p.desc || '')}<br><a href='tel:${p.phone}'>ğŸ“ Ø§ØªØµØ§Ù„</a> | <a target='_blank' href='https://wa.me/${p.phone.replace(/[^0-9+]/g,'')}'>ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>`);
  markers[p.id] = m;
}

function renderMarkers(){ Object.values(markers).forEach(m=> map.removeLayer(m)); markers = {}; providers.forEach(p=> createMarker(p)); }

function renderList(q='', cat='all', city='all'){
  const list = document.getElementById('list'); list.innerHTML='';
  const filtered = providers.filter(p=>{
    if(cat !== 'all' && p.category !== cat) return false;
    if(city !== 'all' && p.city !== city) return false;
    const text = (p.name + ' ' + p.category + ' ' + (p.city||'') + ' ' + (p.desc||'')).toLowerCase();
    if(q && !text.includes(q.trim().toLowerCase())) return false;
    return true;
  });
  if(filtered.length===0){ list.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return; }
  filtered.forEach(p=>{
    const div = document.createElement('div'); div.className='provider';
    div.innerHTML = `
      <img src="${p.img||'https://via.placeholder.com/200x140'}" alt="">
      <div style="flex:1">
        <h3>${escapeHtml(p.name)}</h3>
        <div class="small">${escapeHtml(p.category)} â€¢ ${escapeHtml(p.city||'')}</div>
        <div class="small">${escapeHtml(p.desc||'')}</div>
        <div class="actions-row">
          <a class="btn btn-call" href="tel:${p.phone}">Ø§ØªØµÙ„</a>
          <a class="btn btn-whatsapp" target="_blank" href="https://wa.me/${p.phone.replace(/[^0-9+]/g,'')}">ÙˆØ§ØªØ³Ø§Ø¨</a>
        </div>
      </div>
    `;
    div.querySelector('img').addEventListener('error', e=> e.target.src='https://via.placeholder.com/200x140');
    div.addEventListener('click', ()=>{ map.setView([p.lat,p.lng],16); markers[p.id].openPopup(); });
    list.appendChild(div);
  });
}

function populateFilters(){
  const catSel = document.getElementById('filter'); const citySel = document.getElementById('cityFilter');
  // Ø§Ù…Ø³Ø­ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  const existingCats = new Set(); const existingCities = new Set();
  providers.forEach(p=> { existingCats.add(p.category); if(p.city) existingCities.add(p.city); });
  // Ø£Ø²Ù„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ø¶Ø§ÙÙŠØ©
  Array.from(catSel.options).slice(1).forEach(o=> o.remove());
  Array.from(citySel.options).slice(1).forEach(o=> o.remove());
  existingCats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });
  existingCities.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; citySel.appendChild(o); });
}

// Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø©
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]||c; }); }

// ---------- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ø­Ù„ÙŠ) ----------
function getUsers(){ try{ const raw=localStorage.getItem('users_v1'); return raw ? JSON.parse(raw) : {}; }catch(e){ return {}; } }
function saveUsers(u){ localStorage.setItem('users_v1', JSON.stringify(u)); }

function setCurrentUser(username){ localStorage.setItem('current_user', username); updateAuthUI(); }
function getCurrentUser(){ return localStorage.getItem('current_user'); }
function logout(){ localStorage.removeItem('current_user'); updateAuthUI(); }

function updateAuthUI(){ const user = getCurrentUser(); const userInfo = document.getElementById('userInfo'); const authCard = document.getElementById('authCard'); const addCard = document.getElementById('addCard');
  if(user){ userInfo.textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + user; document.getElementById('authCard').style.display='none'; addCard.style.display='block'; }
  else{ userInfo.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'; document.getElementById('authCard').style.display='block'; addCard.style.display='none'; }
}

// Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
document.getElementById('showSignupBtn').addEventListener('click', ()=>{ document.getElementById('loginForm').style.display='none'; document.getElementById('signupForm').style.display='block'; document.getElementById('authTitle').textContent='Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨'; });
document.getElementById('showLoginBtn').addEventListener('click', ()=>{ document.getElementById('loginForm').style.display='block'; document.getElementById('signupForm').style.display='none'; document.getElementById('authTitle').textContent='ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'; });

document.getElementById('signupBtn').addEventListener('click', ()=>{
  const user = document.getElementById('signup_user').value.trim(); const pass = document.getElementById('signup_pass').value;
  if(!user || !pass){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±'); return; }
  const users = getUsers(); if(users[user]){ alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }
  users[user] = { pass }; saveUsers(users); setCurrentUser(user); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
});

document.getElementById('loginBtn').addEventListener('click', ()=>{
  const user = document.getElementById('login_user').value.trim(); const pass = document.getElementById('login_pass').value;
  if(!user || !pass){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
  const users = getUsers(); if(!users[user] || users[user].pass !== pass){ alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }
  setCurrentUser(user); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) logout(); });

// ---------- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ----------
map.on('click', function(e){
  const user = getCurrentUser();
  if(!user){ alert('Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø¤Ù‚Øª
  if(tempMarker) map.removeLayer(tempMarker);
  tempMarker = L.marker(e.latlng).addTo(map).bindPopup('Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØªØ§Ø±').openPopup();
  // Ø®Ø²Ù‘Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± form dataset
  const addForm = document.getElementById('addForm');
  addForm.dataset.lat = e.latlng.lat; addForm.dataset.lng = e.latlng.lng;
  alert('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ø¢Ù† Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù†Ù‚Ø± "Ø£Ø¶Ù Ø§Ù„Ø®Ø¯Ù…Ø©"');
});

// ---------- Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© (ØªØ³ØªØ¹Ù…Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©) ----------
document.getElementById('addForm').addEventListener('submit', function(ev){
  ev.preventDefault();
  const user = getCurrentUser(); if(!user){ alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
  const name = document.getElementById('f_name').value.trim();
  const category = document.getElementById('f_category').value;
  const phone = document.getElementById('f_phone').value.trim();
  const city = document.getElementById('f_city').value.trim();
  const img = document.getElementById('f_img').value.trim();
  const desc = document.getElementById('f_desc').value.trim();
  const lat = parseFloat(this.dataset.lat); const lng = parseFloat(this.dataset.lng);
  if(!name || !phone || !city){ alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù…ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø©'); return; }
  if(!lat || !lng){ alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const p = { id: Date.now(), name, category, phone, city, img: img || 'https://via.placeholder.com/200x140', desc, lat, lng };
  providers.push(p); saveProviders(); renderMarkers(); renderList(document.getElementById('q').value, document.getElementById('filter').value, document.getElementById('cityFilter').value); populateFilters();
  // Ø£Ø²Ù„ Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø¤Ù‚Øª
  if(tempMarker){ map.removeLayer(tempMarker); tempMarker = null; delete this.dataset.lat; delete this.dataset.lng; }
  this.reset(); alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø­Ù„ÙŠØ§Ù‹');
});

// ---------- ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ JSON ----------
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(providers, null, 2));
  const a = document.createElement('a'); a.href = dataStr; a.download = 'providers.json'; document.body.appendChild(a); a.click(); a.remove();
});

document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());

document.getElementById('importFile').addEventListener('change', function(){
  const f = this.files[0]; if(!f) return; const reader = new FileReader();
  reader.onload = function(){ try{ const arr = JSON.parse(reader.result); if(Array.isArray(arr)){ providers = arr; saveProviders(); renderMarkers(); renderList(); populateFilters(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); }else alert('Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ Ø¨ØµÙŠØºØ© ØµØ­ÙŠØ­Ø©'); }catch(e){ alert('Ø®Ø·Ø£ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'); }}; reader.readAsText(f);
});

// ---------- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« ----------
document.getElementById('q').addEventListener('input', e=> renderList(e.target.value, document.getElementById('filter').value, document.getElementById('cityFilter').value));
document.getElementById('filter').addEventListener('change', e=> renderList(document.getElementById('q').value, e.target.value, document.getElementById('cityFilter').value));
document.getElementById('cityFilter').addEventListener('change', e=> renderList(document.getElementById('q').value, document.getElementById('filter').value, e.target.value));
document.getElementById('refreshBtn').addEventListener('click', ()=>{ providers = loadProviders(); renderMarkers(); renderList(); populateFilters(); alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'); });

// ---------- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© ----------
(function init(){ renderMarkers(); renderList(); populateFilters(); updateAuthUI(); })();

</script>
</body>
</html>
